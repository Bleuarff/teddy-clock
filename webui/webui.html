<!doctype HTML>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Admin Hibou</title>
    <link rel="icon" type="image/png" href="/favicon.png">
  </head>
  <body>
    <h1>Admin Hibou<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADkAAABACAYAAACgNd+MAAAABmJLR0QAAAAAAAD5Q7t/AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH5AQLDDA56tmVagAAABl0RVh0Q29tbWVudABDcmVhdGVkIHdpdGggR0lNUFeBDhcAAARvSURBVGje5ZtPbBVVFMZ/d2pa+9raoq9BG7QlliANUiQBFExIXNiwc2E0mpiwkXTtwoU7N67ZsCFhQYwrJNZF1SXCChNtRAioRFoIiahUW6U8aOnn4p1JxknzOn/uvJnGL3m5k5f77j3fnHPP/e6f5ygIknDOhc8dQAfQCfQCS0ADWHXOrcTrbwhICstHJA1L+lDSNf0XNyQdkzQqqTP6u41EsCbpXUn/qDVWJb0vqX9DEI0Q7JD0kdLhhKTahvGoebCRkuSKpA82SriOSPpG2XBF0gu+vRn4DlVgAtiVsZnngMOA10zrjaRzDkkOeB7oytHUTkl9PqMryOCpVqH0GDCY06Y6MJDDhuwkzVN1SUMtQqkb6MlJsgd4tIUNT0p6Ik04pw3XN4EpSeMWmvG3ugjM5yQ5b+3EPeck7QKmgLeKHJN/AnuBL4Ajkp6KJgnn3BIwl5PkHPB7tF3r5wjwJbDfw4tsOckflDQbSfmfS3pD0uZI3Vcl3co4hSxIejvS1qCk162fELOSDhYmGiR1mt6M4oEZcVTSM1bvhMm1tPjU1NLT1t5na4iKY6HWTZxPUhB8HHgNGAHesTKKJeAKcAH4CzhqmTIpFoBPAAEvAjuAWqzOLPCxlVPOuULCdlLSnQSS7Q/zcBosS5pfJwIa1v+k91CNjMlNsfFRBqYlDXofk7FUPi7pckkEL0saTysIEk0hsRX+JDBWkv4fA96T1Otb38ZDdo+kqyV58qqkPYXKOsPtUJGUgEXrn0JkXeTNHQC2lkRyK/BSOzx5IOX85xN14BVJQWECXVIA9FEu9tniujCBvmqfMrEt7XBJS7IP6C+ZZG/aNWtaksPAaMkkU0+OaUluKTGzhrgL3CuS5K/AzZJJ/gLcKJLkT8ClkkleAn72TjIy8QY0T6fKREdot1eBHsHLNDePy8SE2eHXk7YVWLMOBkomOQBMSKolVT1BilDdgm3hVwCHzZ5EIRsk8aJhFNheEZLbw/k6iTeTJp5u4BDVwiGzy1vi6aa5qVsl7De7vJHsAnZXjORuEp6epfFkf8VI9nvzpGWvOtVE3Ut2NdXfVVGSXUlWJQH/AwSe61XS/iRiQOQ/cywKc2afFw/dp3nqVCUsmF34JHmxYiQv+ia5BJyrGMlzZpe3pVYDOFsxkmfNLq9LrR+B8xUheN7s8b7UugmcqQjJM2aP16VW2Ng0zTsBZeICMG27Ff4neefcNeAUzb3PMnAXOGV2+EfsSP10SYewp9eypxCids/mepsJXpc0lIVg2nANHx/QvG/TTgh4mDTZ+BDef4cdthErZDzGz0TSLgrebjPJW865e1nGYpAjAX1rb7ddXpwpej251rj8vo0h+9D6y3R3J89ieIYMB6I5nPFd2zwZ8egM8HXkqztWLgLLGZtdjiSX3yLff+Wc+6EU+WFXpvfaf0E2Sdpn5Q5Jz0raLOn4OvPfcas3LGks1s6Ite8KFQBJVdA69YYknbSbyQ0rT4aTu69+KgFJPZJ2SuppZ7//AiP7yoJHm/exAAAAAElFTkSuQmCC">
    </h1>

    <div id="ctnr">
      <div class="block" id="alarms-block">
        <table>
          <tr>
            <td>Heure du coucher:</td>
            <td>
              <input type="time" id="dodo-time">
            </td>
          </tr>
          <tr>
            <td class="err hidden" id="err-dodo" colspan="2">L'heure n'est pas valide !</td>
          </tr>
          <tr>
            <td>Heure du lever (semaine):</td>
            <td>
              <input type="time" id="wakeup-time-semaine">
            </td>
          </tr>
          <tr>
            <td class="err hidden" id="err-wake-week" colspan="2">L'heure n'est pas valide !</td>
          </tr>
          <tr>
            <td>Heure du lever (weekend):</td>
            <td>
              <input type="time" id="wakeup-time-weekend">
            </td>
          </tr>
          <tr>
            <td class="err hidden" id="err-wake-weekend" colspan="2">L'heure n'est pas valide !</td>
          </tr>
        </table>

        <button onclick="updateAlarms()" id="go">Mettre à jour</button>
        <span id="alarms-check" class="check hidden">✔</span>

      </div>
      <div class="block" id="time-block">
        <table>
          <tbody>
            <tr>
              <td>Date:</td>
              <td><input type="date" id="date"></td>
            </tr>
            <tr>
              <td class="err hidden" id="err-date" colspan="2">La date n'est pas valide !</td>
            </tr>
            <tr>
              <td>Jour:</td>
              <td>
                <select id="dow">
                  <option value="1">Lundi</option>
                  <option value="2">Mardi</option>
                  <option value="3">Mercredi</option>
                  <option value="4">Jeudi</option>
                  <option value="5">Vendredi</option>
                  <option value="6">Samedi</option>
                  <option value="7">Dimanche</option>
                </select>
              </td>
            </tr>
            <tr>
              <td>Heure:</td>
              <td><input type="time" id="time"></td>
            </tr>
            <tr>
              <td class="err hidden" id="err-time" colspan="2">L'heure n'est pas valide !</td>
            </tr>
          </tbody>
        </table>
        <button onclick="updateTime()" id="goTime">Mettre à jour</button>
        <span id="time-check" class="check hidden">✔</span>
      </div>
    </div>

    <script type="text/javascript">
      'use strict'

      // retrieve values (alarms & timestamp) and set inputs
      void async function(){
        try{
          // retrieve alarms
          let resp = await fetch('/alarms'),
              txt = await resp.text(),
              alarms = txt.split(' ')
          document.getElementById('dodo-time').value = value2Time(alarms[0])
          document.getElementById('wakeup-time-semaine').value = value2Time(alarms[1])
          document.getElementById('wakeup-time-weekend').value = value2Time(alarms[2])
        }
        catch(err){
          console.error(err)
          alert('Erreur: impossible de retrouver les alarmes.')
        }

        try{
          // and now retrieve current ISO-8601 timestamp
          let resp = await fetch('/time'),
              txt = await resp.text(),
              vals = txt.split(' '), // split then assign values
              dow = vals[1],
              date = vals[0].substr(0, 10),
              time = vals[0].substr(11,5)

          document.getElementById('dow').value = dow
          document.getElementById('date').value = date
          document.getElementById('time').value = time

        }
        catch(err){
          console.error(err)
          alert('Erreur: impossible de récuperer l\'heure courante.')
        }
      }()

      // Validates inputs & send request to update all 3 alarms
      async function updateAlarms(){
        const dodo_s = document.getElementById('dodo-time').value,
              wakeup_semaine_s = document.getElementById('wakeup-time-semaine').value,
              wakeup_weekend_s = document.getElementById('wakeup-time-weekend').value

        toggleError(dodo_s, 'dodo')
        toggleError(wakeup_semaine_s, 'wake-week')
        toggleError(wakeup_weekend_s, 'wake-weekend')

        if (!dodo_s || !wakeup_semaine_s || !wakeup_weekend_s){
          console.log('Invalid alarm values')
          return
        }

        // convert string time into integer value, send, validate response.
        const dodo = time2Value(dodo_s),
              wakeupSemaine = time2Value(wakeup_semaine_s),
              wakeupWeekend = time2Value(wakeup_weekend_s)

        try{
          document.querySelectorAll('button').forEach(x => x.setAttribute('disabled', 'disabled'))
          let resp = await fetch(`/alarms?dodo=${dodo}&wakeup1=${wakeupSemaine}&wakeup2=${wakeupWeekend}`, {method: 'POST'})
          if (resp.ok)
            document.getElementById('alarms-check').classList.remove('hidden')
          else
            throw new Error(`error status ${resp.status}`)
        }
        catch(err){
          console.error(err)
          alert('Erreur d\'envoi')
        }
        document.querySelectorAll('button').forEach(x => x.removeAttribute('disabled'))
      }

      // Validates inputs & send request to update current date & time & day of week
      async function updateTime(){
        const date = document.getElementById('date').value,
              dow = document.getElementById('dow').value,
              time = document.getElementById('time').value

        toggleError(date, 'date')
        toggleError(time, 'time')

        if (!date || !dow || !time){
          console.error('Invalid date/time values')
          return
        }
        try{
          document.querySelectorAll('button').forEach(x => x.setAttribute('disabled', 'disabled'))
          let resp = await fetch('/time', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: `t=${date}T${time}:00 ${dow}`
          })
          if (resp.ok)
            document.getElementById('time-check').classList.remove('hidden')
          else
            throw new Error(`error status ${resp.status}`)
        }
        catch(err){
          console.error(err)
          alert('Erreur d\'envoi')
        }
        document.querySelectorAll('button').forEach(x => x.removeAttribute('disabled'))
      }

      // show/hide error message for given input
      function toggleError(val, id){
        const node = document.getElementById(`err-${id}`)
        node.classList[val ? 'add' : 'remove'].call(node.classList, 'hidden')
      }

      // convert time from string to integer value
      function time2Value(val){
        const rx = /^(\d{2}):(\d{2})$/,
              matches = val.match(rx),
              hours = parseInt(matches[1], 10),
              mins = parseInt(matches[2], 10)

        return hours * 60 + mins
      }

      // convert time as integer to readable string
      function value2Time(val){
        const hours = Math.floor(val / 60).toString().padStart(2, '0'),
              mins = (val % 60).toString().padStart(2, '0')
        return `${hours}:${mins}`
      }
    </script>

    <style>
      body{
        width: 100vw;
        height: 100vh;
        margin: 0;
        text-align: center;
        font-family: 'Times New Roman';
        font-size: 1.1em;
      }
      * {box-sizing: border-box;}
      h1{
        color: white;
        background: #0063b8;
        margin: 0;
        padding: 2px 0;
        font-size: 1.8em;
        height: 40px;
      }
      img{
        height: 35px;
        margin-left: .8em;
      }
      #ctnr{
        width: 100%;
        height: calc(100% - 40px - 1em);
        max-width: 700px;
        max-height: 600px;
        padding: 0;
        margin: 0 auto;
        margin-top: 1em;
        display: flex;
        flex-flow: column nowrap;
        justify-content: space-between;
      }

      #time-block{
        margin-bottom: 2em;
      }

      table{
        border-collapse: collapse;
        margin: 0 auto;
        margin-bottom: .8em;
        border: none;
        width: 100%;
      }

      #time-block td:first-child{
        width: 35%;
      }

      td{
        width:50%;
        padding-top: .6em;
      }
      td:first-child:not(.err){
        text-align: right;
        padding-right: .4em;
      }
      td:nth-child(2){
        text-align: left;
        padding-left: .4em;
      }
      td input{
        min-width: 8em;
      }
      button{
        width: 65%;;
        height: 3.5em;
        margin: .5em 0;
      }
      .err{
        color: red;
        font-size: .9em;
        text-align:center;
        padding-bottom: .8em;
      }
      .hidden{
        display: none !important;
      }
      button{
        color: white;
        background: #0063b7;
      }

      button:disabled{
        color: #686868;
        background: #e4e4e4;
      }

      .check{
        position: absolute;
        font-size: 2.3em;
        padding-left: 10px;
        color: green;
      }
    </style>
  </body>
</html>
